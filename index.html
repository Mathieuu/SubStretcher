<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SubStretcher</title>

  <!-- Bootstrap -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/substretcher.css" rel="stylesheet">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
    </head>
    <body>
      <div class="container">
        <div class="col-lg-4">
          <h1>SubStretcher</h1>
          <form>
            <div class="form-group">
              <label>Original file encoding</label>
              <select id="comboOldFileEncoding" class="btn btn-default btn-sm">
                <option value="windows-1252">Windows-1252 (Default)</option>
                <option value="UTF-8">UTF-8</option>
              </select>
            </div>
            <div class="form-group">
              <label>Pick your SRT file</label>
              <input type="file" class="filestyle" data-buttonText="Find SRT" data-input="true" id="fileinput" >
            </div>
            <div class="form-group">
              <label id="labelPreviewNumber" style="display: none">Pick the last real subtitle</label>
              <p id="subPreviewText" style="display: none;"><p>
              <button type="button" class="btn btn-default btn-sm" id="btnPrevious" style="display: none;"><span class="glyphicon glyphicon-arrow-left"></span></button>
              <button type="button" class="btn btn-default btn-sm" id="btnNext" style="display: none;"><span class="glyphicon glyphicon-arrow-right"></span></button>
            </div>
            <div class="form-group">
              <label id="labelTime" style="display: none">The exact time this subtitle should be display</label>
              <input type="text" class="form-control" id="inputTime" style="display: none;" placeholder="hh:mm:ss,xxx">
            </div>
            <div class="form-group">
              <label id="labelNewFileEncoding" style="display: none;">New file encoding</label>
              <select id="comboNewFileEncoding" class="btn btn-default btn-sm" style="display: none;">
                <option value="UTF-8">UTF-8</option>
                <option value="windows-1252" disabled>Windows-1252 (Coming soon)</option>
              </select>
            </div>
         <!--   <div class="form-group">
              <label for="number">Number last subtitle</label>
              <input type="text" class="form-control" id="inputNumber" placeholder="Sub number">
            </div>  -->
            <button type="submit" class="btn btn-primary" id="btnSubmit" style="display: none;">Resync</button>
          </div>
        </form>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script type="text/javascript" src="js/filesaver.js"> </script>
    <script type="text/javascript" src="js/srt-parser.js"> </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-filestyle.min.js"> </script>
    <script type="text/javascript" src="js/underscore-min.js"> </script>
    <script type="text/javascript" src="js/maskedinput-min.js"> </script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>

    <script type="text/javascript">

    var parsedSubs = new Array();
    var nameFile = "";
    var indexCurrentlyDisplayedSub = 0;

     $("#inputTime").mask("99:99:99,999");

    function readSingleFile(evt) {
        //Retrieve the first (and only!) File from the FileList object
        var f = evt.target.files[0];

        if (f) {
          var r = new FileReader();
          r.onload = function(e) {

            if(f.size > 5000000){
              alert("This file is too big");

              $('#btnNext').hide();
              $('#btnPrevious').hide();
              $('#labelPreviewNumber').hide();
              $('#subPreviewText').hide();
              $('#labelTime').hide();
              $('#inputTime').hide();
              $('#labelNewFileEncoding').hide();
              $('#comboNewFileEncoding').hide();
              $('#btnSubmit').hide();

              return;
            }

            var contents = e.target.result;
            var splittedContent = contents.split((contents.search("\n\r\n") != -1) ? "\n\r\n" : "\n\n");
            nameFile = f.name;

            //Build the array
            _.each(splittedContent, function(str){
              createSrtData(parsedSubs,str);
            });

            indexCurrentlyDisplayedSub = parsedSubs.length-1;

            $('#labelPreviewNumber').text("Corresponding to subtitle " + parsedSubs[indexCurrentlyDisplayedSub].number);
            $('#subPreviewText').text(parsedSubs[indexCurrentlyDisplayedSub].text);


            if(indexCurrentlyDisplayedSub < parsedSubs.length-1){
              $('#btnNext').show();
            } else {
              $('#btnNext').hide();
            }
            if(indexCurrentlyDisplayedSub > 0){
               $('#btnPrevious').show();
            } else {
              $('#btnPrevious').hide();
            }

            $('#labelPreviewNumber').show();
            $('#subPreviewText').show();
            $('#labelTime').show();
            $('#inputTime').show();
            $('#labelNewFileEncoding').show();
            $('#comboNewFileEncoding').show();
            $('#btnSubmit').show();
          }
          r.readAsText(f, $("#comboOldFileEncoding").val());
        } else {
          alert("Failed to load file");
        }
      }

      function processFile(evt){

        //Remove the last subtitles
        var numLastSub =  parsedSubs[indexCurrentlyDisplayedSub].number;
        var timeLastSub = parseTimeStringToInteger($("#inputTime").val());

        parsedSubs = _.filter(parsedSubs, function(sub){ return sub.number <= numLastSub; });

        //Adjust time
        var lastCurrentSubtitleTime = parsedSubs[parsedSubs.length-1].startTime;
        _.each(parsedSubs, function(sub){
          sub.startTime = getNewTime(sub.startTime, lastCurrentSubtitleTime, timeLastSub);
          sub.endTime = getNewTime(sub.endTime, lastCurrentSubtitleTime, timeLastSub);
        });

        //Build final string
        var finalText = "";

        _.each(parsedSubs, function(sub){
          finalText += sub.number + "\n";
          finalText += parseTimeIntegerToString(sub.startTime) + " --> " + parseTimeIntegerToString(sub.endTime);

          if(sub.specificStyling){
            finalText += "  " + sub.specificStyling;
          }

          finalText += "\n" + sub.text + "\n\n";
        });

        var blob = new Blob([finalText], {type: "text/plain;charset=utf-8"});
        saveAs(blob, nameFile);
      }

      function nextSub(e){
          if(indexCurrentlyDisplayedSub < parsedSubs.length-1){
              indexCurrentlyDisplayedSub++;
          }

          if(indexCurrentlyDisplayedSub < parsedSubs.length-1){
            $('#btnNext').show();
          } else {
            $('#btnNext').hide();
          }
          if(indexCurrentlyDisplayedSub > 0){
             $('#btnPrevious').show();
          } else {
            $('#btnPrevious').hide();
          }

          $('#labelPreviewNumber').text("Corresponding to subtitle " + parsedSubs[indexCurrentlyDisplayedSub].number);
          $('#subPreviewText').text(parsedSubs[indexCurrentlyDisplayedSub].text);
      }

      function previousSub(e){
          if(indexCurrentlyDisplayedSub > 0){
            indexCurrentlyDisplayedSub--;
          }

          if(indexCurrentlyDisplayedSub < parsedSubs.length-1){
            $('#btnNext').show();
          } else {
            $('#btnNext').hide();
          }
          if(indexCurrentlyDisplayedSub > 0){
             $('#btnPrevious').show();
          } else {
            $('#btnPrevious').hide();
          }

          $('#labelPreviewNumber').text("Corresponding to subtitle " + parsedSubs[indexCurrentlyDisplayedSub].number);
          $('#subPreviewText').text(parsedSubs[indexCurrentlyDisplayedSub].text);
      }

      function oldFileEncodingChanged(e){

        $('#fileinput').filestyle('clear');

        $('#btnNext').hide();
        $('#btnPrevious').hide();
        $('#labelPreviewNumber').hide();
        $('#subPreviewText').hide();
        $('#labelTime').hide();
        $('#inputTime').hide();
        $('#labelNewFileEncoding').hide();
        $('#comboNewFileEncoding').hide();
        $('#btnSubmit').hide();
      }

      document.getElementById('fileinput').addEventListener('change', readSingleFile, false);
      document.getElementById('btnSubmit').addEventListener('click', processFile, false);
      document.getElementById('btnPrevious').addEventListener('click', previousSub, false);
      document.getElementById('btnNext').addEventListener('click', nextSub, false);
      document.getElementById('comboOldFileEncoding').addEventListener('change', oldFileEncodingChanged, false);
      </script>

    </body>
    </html>
